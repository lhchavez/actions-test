name: Backport to older releases
on:
  push:
    branches:
    - master

jobs:

  backport:
    strategy:
      fail-fast: false
      matrix:
        branch: [ 'release-0.28', 'release-0.27' ]
    name: Backport change to branch ${{ matrix.branch }}

    runs-on: ubuntu-20.04

    steps:
    - name: Check out code
      uses: actions/checkout@v1
      with:
        fetch-depth: 0
    - name: Create a cherry-pick PR
      run: |
        if ! git diff --quiet HEAD^ HEAD -- vendor/libgit2; then
          echo '::warning::Skipping cherry-pick since it is a vendored libgit2 bump'
          exit 0
        fi

        BRANCH_NAME="cherry-pick-${{ github.run_id }}-${{ matrix.branch }}"

        git config --global user.name "release-bot"
        git config --global user.email "release-bot@libgit2.org"

        git checkout "${{ matrix.branch }}"
        git switch -c "${BRANCH_NAME}"
        git cherry-pick -x "${{ github.sha }}"
        git push --set-upstream origin "${BRANCH_NAME}"
        gh pr create \
          --base "${{ matrix.branch }}" \
          --title "$(git show --no-pager --format="%s" --no-patch HEAD)" \
          --body "$(git show --no-pager --format="%b" --no-patch HEAD)"
